## 第三章 系统总体设计

### 3.1 系统开发运行环境
#### 3.1.1 开发环境与运行环境

表3-1 系统基础软件环境要求

| 环境类别 | 配置项 | 版本要求 | 说明 |
|---------|--------|----------|------|
| 操作系统 | 跨平台支持 | - | 支持Windows/Linux/macOS |
| 开发语言 | C++ | C++17及以上 | 主要开发语言 |
| GUI框架 | Qt | 6.0及以上 | 用户界面框架 |
| Python环境 | Python | 3.8及以上 | 爬虫模块必需 |

表3-2 系统依赖组件要求

| 组件名称 | 版本要求 | 主要用途 | 重要性 |
|---------|----------|----------|--------|
| spdlog | v1.9.0 | 系统日志管理 | 必需 |
| nlohmann_json | v3.9.0 | JSON数据处理 | 必需 |
| curl | v7.0.0 | 网络通信 | 必需 |
| SQLite | v3.0.0 | 本地数据存储 | 必需 |

表3-3 Python爬虫模块依赖要求
| 组件名称 | 版本要求 | 主要用途 | 重要性 |
|---------|----------|----------|--------|
| requests | >=2.31.0 | HTTP请求处理 | 必需 |
| beautifulsoup4 | >=4.12.0 | HTML解析 | 必需 |
| selenium | >=4.16.0 | 动态网页爬取 | 必需 |
| webdriver_manager | >=4.0.1 | WebDriver管理 | 必需 |
| urllib3 | >=2.1.0 | URL处理 | 必需 |
| logging | Python内置 | 日志管理 | 必需 |
| lxml | >=5.1.0 | XML/HTML解析器 | 必需 |
| aiohttp | >=3.9.0 | 异步HTTP客户端 | 可选 |
| pandas | >=2.1.0 | 数据处理 | 可选 |

表3-4 爬虫模块浏览器要求

| 组件名称 | 说明 | 重要性 |
|---------|------|--------|
| Chrome/Firefox | 支持Chrome或Firefox浏览器 | 必需其一 |
| WebDriver | 对应浏览器的WebDriver | 必需 |


### 3.2 系统架构设计

#### 3.2.1 总体架构

本系统采用经典的三层架构设计，包括表现层、业务逻辑层和数据层。这种架构设计既保证了系统各个组件之间的解耦，又提供了良好的可扩展性和维护性。系统整体架构图如下：

![image](docs/image/mermaid-2025418 152830.png)

表现层采用基于Qt Quick技术的现代化图形用户界面，实现了响应式设计，支持深色和浅色主题切换，并提供了流畅的多轮对话和实时反馈机制。这种设计不仅提升了用户体验，还确保了系统在不同使用场景下的适应性。

业务逻辑层是系统的核心，包含了API服务管理、搜索引擎和RAG检索增强等关键模块。这一层负责处理复杂的业务逻辑，协调各个功能模块之间的交互，确保系统运行的稳定性和效率。

数据层主要负责数据的存储、管理和访问，包括数据库管理、爬虫管理和缓存管理等模块。通过合理的数据组织和管理策略，确保了系统数据的高效访问和安全存储。

### 3.3 核心模块设计

本系统的核心功能模块主要包括AI服务管理、搜索服务管理、RAG实现和爬虫管理四个部分。这些模块通过紧密协作，共同构建了一个高效、可靠的智能搜索系统。以下将详细阐述各个核心模块的设计思路和实现方案。

AI服务管理模块（AIServiceManager）作为系统的核心组件之一，主要负责统一管理和调度多个大语言模型服务。该模块采用统一的API接口设计，实现了对Kimi、Qwen、Hunyuan、DeepSeek等多个AI模型的集成管理。在实现过程中，模块设计了基于权重的动态负载均衡策略，通过实时健康检查和智能请求分发机制，确保了模型服务的高可用性。同时，模块还实现了完善的故障转移机制，包括服务异常自动检测、故障模型自动切换以及故障恢复等功能，有效保障了系统的稳定运行。

搜索服务管理模块（SearchServiceManager）整合了Bocha、Exa等高性能搜索引擎，通过提供统一的搜索接口，实现了强大的混合搜索能力。该模块的核心特点是实现了多引擎并行搜索和结果合并机制，通过深度语义理解和多维度评分体系，确保搜索结果的准确性和相关性。在上下文感知方面，模块通过维护完整的会话上下文，实现了多轮对话中的查询优化，为用户提供个性化的搜索体验。模块的设计充分考虑了性能优化，采用多级缓存策略，有效提升了搜索响应速度。

检索增强生成（RAG）模块是系统的特色功能，通过先进的检索技术显著提升了AI模型的回答质量。该模块包含了完整的文档处理系统，能够高效处理PDF、HTML、图像等多种格式的文档，实现文档的结构化预处理和版本管理。在向量数据库集成方面，模块预留了对Milvus、Qdrant、Chroma等主流向量数据库的支持接口，实现了高效的向量索引和检索功能。智能检索引擎的设计采用了混合检索策略，通过语义排序和相关性优化，实现了精准的信息检索和匹配。

爬虫管理模块（CrawlerManager）采用Python爬虫桥接技术，实现了系统数据来源的自动化采集和更新。该模块设计了完善的爬虫任务管理系统，支持多种网页类型的数据采集，并实现了基于优先级的任务调度机制。在数据预处理方面，模块提供了强大的数据清洗、格式转换和质量验证功能，确保采集数据的质量和可用性。为了保证爬虫系统的稳定运行，模块实现了严格的资源管理机制，包括并发控制、代理池管理和访问频率控制等功能。

这些核心模块都遵循统一的日志管理和错误处理机制，通过spdlog框架实现了全方位的日志记录。模块间通过标准化的接口进行通信，采用松耦合的设计原则，确保了系统的可维护性和可扩展性。同时，各模块都实现了完整的性能监控和优化机制，通过实时监控和动态调整，保证了系统在高负载情况下的稳定运行。通过这些核心模块的有机结合，系统实现了高效、智能的搜索服务，为用户提供了优质的使用体验。

### 3.4 数据库设计

系统的数据存储架构采用了灵活可扩展的设计方案。当前阶段使用SQLite作为主数据库，计划后续迁移至Redis配合向量数据库的组合方案，以支持更大规模的数据存储和更高效的检索需求。核心数据表设计涵盖了用户会话管理、搜索历史记录、知识库数据存储和系统配置信息等关键数据实体，为系统的各项功能提供了可靠的数据支持。

对话会话表 dialogue_sessions，如表4-1所示：




表4-1 对话会话表
| 字段 | 名称 | 类型 | 长度 | 允许空值 |
|------|------|------|------|----------|
| session_id | 会话ID | TEXT | - | NO |
| created_at | 创建时间 | DATETIME | - | YES |
| last_updated | 最后更新时间 | DATETIME | - | YES |
| title | 会话标题 | TEXT | - | YES |
| status | 会话状态 | TEXT | - | YES |





对话记录表 dialogue_records，如表4-2所示：



表4-2 对话记录表
| 字段 | 名称 | 类型 | 长度 | 允许空值 |
|------|------|------|------|----------|
| id | 记录ID | INTEGER | - | NO |
| session_id | 会话ID | TEXT | - | NO |
| turn_number | 对话轮次 | INTEGER | - | NO |
| user_query | 用户查询 | TEXT | - | NO |
| intent_type | 意图类型 | TEXT | - | NO |
| intent_result | 意图结果 | TEXT | - | NO |
| search_result | 搜索结果 | TEXT | - | NO |
| timestamp | 创建时间 | DATETIME | - | YES |

### 3.5 安全与性能设计

本系统在安全性设计方面采用了多层次防护策略。首先，在应用层面实现了完整的访问控制体系，通过 spdlog 框架构建了全方位的日志审计系统，实现了从调试到错误的四级日志分级管理。其次，在数据传输层面，系统基于 curl 库实现了安全的网络通信机制，确保了数据传输过程的安全性。同时，系统对各类 AI 服务和搜索服务的 API 密钥采用了严格的环境变量管理方案，有效防止了敏感信息泄露。

在性能优化方面，本系统制定了严格的性能指标要求。通过采用 Qt Concurrent 模块实现的并发处理机制，系统能够有效管理并发任务，确保在高负载情况下维持稳定性能。具体性能指标包括：单次搜索响应时间控制在 500 毫秒以内，单实例内存占用不超过 500MB，并支持超过 1000 用户的并发访问。为了达到这些性能目标，系统实现了基于 Redis 的多级缓存架构，包括搜索结果缓存、会话状态管理和 API 调用频率控制等机制。

系统的可扩展性设计采用了双向扩展策略。在水平扩展方面，系统支持 2 到 10 个容器实例的动态伸缩；在垂直扩展方面，可根据负载情况动态调整单个实例的资源配置，CPU 核心数可在 2 至 8 核之间调整，内存可在 4GB 至 16GB 范围内配置。系统采用基于 qt:6.5-desktop 的容器化部署方案，为未来向微服务架构演进预留了充分的扩展空间。

在系统监控方面，构建了完整的性能指标监控体系。通过 spdlog 实现的日志系统支持 debug、info、warn 和 error 四个级别的日志记录，并配备了自动的日志轮转机制。系统重点监控指标包括 API 服务响应时间、搜索准确率、系统资源利用率等关键性能参数。这些监控指标通过可视化界面实时展示，为系统运维和性能优化提供了有力的数据支持。

通过以上安全与性能设计，本系统在保证功能完整性的同时，实现了高安全性、高性能和高可用性的设计目标。这些设计不仅满足了当前系统的运行需求，同时也为系统的未来扩展提供了可靠的技术基础。


